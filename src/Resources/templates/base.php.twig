<?php

use TSantos\Serializer\Exception\InvalidArgumentException;
use TSantos\Serializer\AbstractContext;
use TSantos\Serializer\SerializationContext;
use TSantos\Serializer\DeserializationContext;
{% for class in hierarchy_classes %}
use {{ class }};
{% endfor %}

/**
 * THIS CLASS WAS GENERATED BY THE SERIALIZER. DO NOT EDIT THIS FILE.
 * @internal
 */
final class {{ class_name }} extends {{ base_class_name }}
{
    private $exposedGroups = {{ exported_groups|raw }};

    /**
     * @param {{ target_class_name }} $object
     * @param SerializationContext $context
     * @return array
     */
    public function serialize($object, SerializationContext $context): array
    {
        if (!$object instanceof {{ target_class_name }}) {
            throw new InvalidArgumentException(sprintf('%s is able to serialize only instances of "%s" only. "%s" given', get_class($this), {{ target_class_name }}::class, is_object($object) ? get_class($object) : gettype($object)));
        }

{% if properties|length == 0 and virtual_properties|length == 0 %}
        return [];
{% else %}
        $data = [];
        $shouldSerializeNull = $context->shouldSerializeNull();
{% block serializer_initialization '' %}

{% for prop in properties if prop.getter is defined %}{% block property_getters '' %}{% endfor %}
{% for prop in virtual_properties %}{% block virtual_property_getters '' %}{% endfor %}
        static $contextKeys = [];
        $contextId = spl_object_hash($context);

        if (!isset($contextKeys[$contextId])) {
            $contextKeys[$contextId] = $this->getExposedKeys($context);
        }

        $data = array_intersect_key($data, $contextKeys[$contextId]);

        return $data;
{% endif %}
    }

    /**
     * @param {{ target_class_name }} $object
     * @param array $data
     * @param DeserializationContext $context
     * @return {{ target_class_name }}
     */
    public function deserialize($object, array $data, DeserializationContext $context)
    {
        if (!$object instanceof {{ target_class_name }}) {
            throw new InvalidArgumentException(sprintf('%s is able to deserialize only instances of "%s" only. "%s" given', get_class($this), Person::class, is_object($object) ? get_class($object) : gettype($object)));
        }
{% if properties|length > 0 %}

        static $contextKeys = [];
        $contextId = spl_object_hash($context);

        if (!isset($contextKeys[$contextId])) {
            $contextKeys[$contextId] = $this->getExposedKeys($context);
        }

        $data = array_intersect_key($data, $contextKeys[$contextId]);
{% block deserializer_initialization '' %}

{% for prop in properties if prop.setter and not prop.readOnly%}
{% block property_setters '' %}
{% endfor %}
        return $object;
{% endif %}
    }

    /**
     * @param AbstractContext $context
     * @return array
     */
    final private function getExposedKeys(AbstractContext $context)
    {
        $contextGroups = $context->getGroups();
        $exposedGroups = array_intersect_key($this->exposedGroups, $contextGroups);
        $exposedKeys = array_reduce($exposedGroups, function ($keys, $groupKeys) {
            array_push($keys, ...(array_keys($groupKeys)));
            return $keys;
        }, []);

        return array_flip($exposedKeys);
    }
{% block additional_methods '' %}
}
